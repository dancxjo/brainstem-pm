<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Brainstem Teleop</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, sans-serif; margin: 20px; }
      .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
      .hud { margin-top: 12px; padding: 8px; background: #f6f6f6; border-radius: 6px; }
      .keys { font-family: monospace; padding: 4px 8px; background: #eee; border-radius: 4px; }
      .pad { display: grid; grid-template-columns: 60px 60px 60px; grid-template-rows: 60px 60px 60px; gap: 6px; margin: 10px 0; }
      .pad .cell { background: #fafafa; border: 1px solid #ddd; border-radius: 6px; display: flex; align-items: center; justify-content: center; }
      .pad button.cell { cursor: pointer; font-size: 20px; user-select: none; }
      .on { background: #cdeffd; border-color: #7fd1f6; }
      #log { height: 180px; overflow: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; background: #111; color: #aee; padding: 8px; border-radius: 6px; }
      button { padding: 6px 10px; }
      input[type=range] { width: 200px; }
      .small { color: #666; font-size: 12px; }
      /* Joystick */
      .joy-wrap { display: flex; gap: 18px; align-items: center; flex-wrap: wrap; }
      #joystick { position: relative; width: 180px; height: 180px; border-radius: 50%; background: #f4f4f4; border: 1px solid #ddd; touch-action: none; }
      #joyKnob { position: absolute; width: 64px; height: 64px; border-radius: 50%; background: #e8f6ff; border: 2px solid #7fd1f6; left: 50%; top: 50%; transform: translate(-50%, -50%); pointer-events: none; }
      .wasd { display: grid; grid-template-columns: 50px 50px 50px; grid-template-rows: 50px 50px; gap: 6px; }
      .wasd .cell { font-weight: 600; }
    </style>
  </head>
  <body>
    <h2>Brainstem Teleop</h2>
    <div class="hud">
      <div>Open this page locally at <span class="keys">http://localhost:2525</span>. Use arrow keys to drive:</div>
      <ul>
        <li><span class="keys">↑</span> forward, <span class="keys">↓</span> reverse, <span class="keys">←</span>/<span class="keys">→</span> turn</li>
        <li><span class="keys">Space</span> stop; <span class="keys">S</span> safe-enable (clear ESTOP); <span class="keys">E</span> ESTOP</li>
      </ul>
    </div>

    <div class="row">
      <label>Max linear (m/s): <input id="vmax" type="range" min="0.05" max="0.6" value="0.25" step="0.05"/> <span id="vmaxv">0.25</span></label>
      <label>Max angular (rad/s): <input id="wmax" type="range" min="0.5" max="6.0" value="2.0" step="0.5"/> <span id="wmaxv">2.0</span></label>
      <button id="btnStop">Stop</button>
      <button id="btnSafe">SAFE=1</button>
      <button id="btnEstop">ESTOP (SAFE=0)</button>
    </div>

    <div class="pad" id="pad">
      <div></div>
      <button id="kUp" class="cell" type="button" aria-label="Forward">↑</button>
      <div></div>
      <button id="kLeft" class="cell" type="button" aria-label="Turn Left">←</button>
      <div></div>
      <button id="kRight" class="cell" type="button" aria-label="Turn Right">→</button>
      <div></div>
      <button id="kDown" class="cell" type="button" aria-label="Reverse">↓</button>
      <div></div>
    </div>

    <div class="joy-wrap">
      <div>
        <div class="small">Touch Joystick</div>
        <div id="joystick" aria-label="Touch joystick">
          <div id="joyKnob"></div>
        </div>
      </div>
      <div>
        <div class="small">WASD Pad</div>
        <div class="wasd">
          <div></div>
          <button id="kW" class="cell" type="button" aria-label="W">W</button>
          <div></div>
          <button id="kA" class="cell" type="button" aria-label="A">A</button>
          <button id="kS" class="cell" type="button" aria-label="S">S</button>
          <button id="kD" class="cell" type="button" aria-label="D">D</button>
        </div>
      </div>
    </div>

    <div class="small" id="conn">Connecting…</div>
    <pre id="log"></pre>

    <script>
      const log = (s) => {
        const el = document.getElementById('log');
        el.textContent += s + "\n";
        el.scrollTop = el.scrollHeight;
      };

      const padOn = (id, on) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.toggle('on', !!on);
      };

      // UI sliders
      const vmaxEl = document.getElementById('vmax');
      const wmaxEl = document.getElementById('wmax');
      const vmaxVal = document.getElementById('vmaxv');
      const wmaxVal = document.getElementById('wmaxv');
      const updateVals = () => { vmaxVal.textContent = (+vmaxEl.value).toFixed(2); wmaxVal.textContent = (+wmaxEl.value).toFixed(1); };
      vmaxEl.addEventListener('input', updateVals); wmaxEl.addEventListener('input', updateVals); updateVals();

      let ws;
      let keys = { up:false, down:false, left:false, right:false };
      let lastSend = 0;
      let lastTwist = {vx: 0, wz: 0};
      // Joystick state
      let joyActive = false;
      let joyVx = 0, joyWz = 0;

      function connect() {
        const url = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws';
        ws = new WebSocket(url);
        ws.onopen = () => { document.getElementById('conn').textContent = 'Connected'; log('# connected'); };
        ws.onmessage = (ev) => {
          try {
            const m = JSON.parse(ev.data);
            if (m.type === 'rx' && m.line) { log(m.line); }
            if (m.type === 'tx' && m.line) { log('>> ' + m.line); }
            if (m.type === 'hello') { log(`# serial=${m.serial} baud=${m.baud}`); }
          } catch {
            // fall back to raw line
            log(String(ev.data));
          }
        };
        ws.onclose = () => { document.getElementById('conn').textContent = 'Disconnected (retrying)'; log('# disconnected'); setTimeout(connect, 1000); };
        ws.onerror = () => { /* handled by close */ };
      }
      connect();

      const send = (obj) => {
        // Client-side debug of outbound intent
        try { log('>> ' + JSON.stringify(obj)); } catch {}
        if (ws && ws.readyState === 1) ws.send(JSON.stringify(obj));
      };

      function computeTwist() {
        const vmax = +vmaxEl.value;
        const wmax = +wmaxEl.value;
        if (joyActive) {
          return { vx: joyVx, wz: joyWz };
        }
        let vx = 0, wz = 0;
        if (keys.up) vx += vmax;
        if (keys.down) vx -= vmax;
        if (keys.left) wz += wmax;
        if (keys.right) wz -= wmax;
        return {vx, wz};
      }

      function tick() {
        const now = performance.now();
        // 20 Hz when keys active, else 1 Hz heartbeat to keep link up
        const active = joyActive || keys.up || keys.down || keys.left || keys.right;
        const period = active ? 50 : 1000;
        if (now - lastSend >= period) {
          const {vx, wz} = computeTwist();
          lastSend = now;
          if (active || vx !== lastTwist.vx || wz !== lastTwist.wz) {
            send({type: 'twist', vx, wz});
            lastTwist = {vx, wz};
          } else {
            // keep-alive ping
            send({type: 'ping'});
          }
        }
        requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);

      function setKey(k, v) {
        if (k === 'ArrowUp') { keys.up = v; padOn('kUp', v); }
        if (k === 'ArrowDown') { keys.down = v; padOn('kDown', v); }
        if (k === 'ArrowLeft') { keys.left = v; padOn('kLeft', v); }
        if (k === 'ArrowRight') { keys.right = v; padOn('kRight', v); }
      }

      // Make on-screen arrows behave like real buttons (mouse/touch)
      function bindPadButton(id, keyName) {
        const el = document.getElementById(id);
        if (!el) return;
        const press = (e) => { e.preventDefault(); try { el.setPointerCapture(e.pointerId); } catch {} setKey(keyName, true); };
        const release = (e) => { e && e.preventDefault && e.preventDefault(); setKey(keyName, false); };
        if (window.PointerEvent) {
          el.addEventListener('pointerdown', press);
          el.addEventListener('pointerup', release);
          el.addEventListener('pointercancel', release);
          el.addEventListener('lostpointercapture', release);
        } else {
          // Fallback for older browsers
          el.addEventListener('mousedown', press);
          el.addEventListener('mouseup', release);
          el.addEventListener('mouseleave', release);
          el.addEventListener('touchstart', (e) => { press(e); });
          el.addEventListener('touchend', release);
          el.addEventListener('touchcancel', release);
        }
      }
      bindPadButton('kUp', 'ArrowUp');
      bindPadButton('kDown', 'ArrowDown');
      bindPadButton('kLeft', 'ArrowLeft');
      bindPadButton('kRight', 'ArrowRight');

      // WASD overlay mapped to arrows
      bindPadButton('kW', 'ArrowUp');
      bindPadButton('kS', 'ArrowDown');
      bindPadButton('kA', 'ArrowLeft');
      bindPadButton('kD', 'ArrowRight');

      // Joystick interactions
      (function setupJoystick(){
        const joy = document.getElementById('joystick');
        const knob = document.getElementById('joyKnob');
        if (!joy || !knob) return;
        const center = () => { knob.style.left = '50%'; knob.style.top = '50%'; };
        center();
        const getRect = () => joy.getBoundingClientRect();
        const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
        let pid = null;
        const onDown = (e) => {
          e.preventDefault();
          const pId = (e.pointerId != null) ? e.pointerId : null;
          pid = pId;
          try { if (pId != null) joy.setPointerCapture(pId); } catch {}
          joyActive = true;
          onMove(e);
        };
        const onMove = (e) => {
          if (!joyActive) return;
          const r = getRect();
          const cx = r.left + r.width/2;
          const cy = r.top + r.height/2;
          const x = (e.clientX != null) ? e.clientX : (e.touches && e.touches[0] ? e.touches[0].clientX : cx);
          const y = (e.clientY != null) ? e.clientY : (e.touches && e.touches[0] ? e.touches[0].clientY : cy);
          let dx = x - cx;
          let dy = y - cy;
          const maxR = r.width/2 - 6; // padding
          const dist = Math.hypot(dx, dy) || 1;
          const scale = Math.min(1, dist / maxR);
          dx = dx / dist * scale * maxR;
          dy = dy / dist * scale * maxR;
          knob.style.left = `${50 + (dx / (r.width/2)) * 50}%`;
          knob.style.top  = `${50 + (dy / (r.height/2)) * 50}%`;
          const vmax = +vmaxEl.value;
          const wmax = +wmaxEl.value;
          // Map: up (negative dy) -> +vx; left (negative dx) -> +wz
          joyVx = clamp(-dy / maxR, -1, 1) * vmax;
          joyWz = clamp(-dx / maxR, -1, 1) * wmax;
        };
        const onUp = (e) => {
          e && e.preventDefault && e.preventDefault();
          joyActive = false; joyVx = 0; joyWz = 0; center();
          if (pid != null) { try { joy.releasePointerCapture(pid); } catch {} pid = null; }
        };
        if (window.PointerEvent) {
          joy.addEventListener('pointerdown', onDown);
          joy.addEventListener('pointermove', onMove);
          joy.addEventListener('pointerup', onUp);
          joy.addEventListener('pointercancel', onUp);
          joy.addEventListener('lostpointercapture', onUp);
        } else {
          joy.addEventListener('mousedown', onDown);
          joy.addEventListener('mousemove', onMove);
          joy.addEventListener('mouseup', onUp);
          joy.addEventListener('mouseleave', onUp);
          joy.addEventListener('touchstart', onDown, {passive:false});
          joy.addEventListener('touchmove', onMove, {passive:false});
          joy.addEventListener('touchend', onUp, {passive:false});
          joy.addEventListener('touchcancel', onUp, {passive:false});
        }
      })();

      window.addEventListener('keydown', (e) => {
        if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", " ", "Spacebar"].includes(e.key)) e.preventDefault();
        if (e.repeat) return;
        if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) setKey(e.key, true);
        if (e.key === ' ' || e.code === 'Space') { lastTwist = {vx: 0, wz: 0}; send({type:'twist', vx:0, wz:0}); }
        if (e.key === 's' || e.key === 'S') { send({type:'safe', enable:true}); }
        if (e.key === 'e' || e.key === 'E') { send({type:'safe', enable:false}); }
      });
      window.addEventListener('keyup', (e) => {
        if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) { e.preventDefault(); setKey(e.key, false); }
      });

      document.getElementById('btnStop').onclick = () => { lastTwist = {vx:0, wz:0}; send({type:'twist', vx:0, wz:0}); };
      document.getElementById('btnSafe').onclick = () => send({type:'safe', enable:true});
      document.getElementById('btnEstop').onclick = () => send({type:'safe', enable:false});
    </script>
  </body>
  </html>
